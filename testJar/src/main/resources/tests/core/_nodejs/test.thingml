import "../test.thingml"

object fs;

thing TestDumpNodejs includes TestDump
@javascript "node"
{

    property fs : fs = 'require(\'fs\')'

	function write(string : String)
	do
    	'' & fs & '.appendFileSync("dump", ' & string & ');'
        print(string)
	end

	statechart JavaHarness init Testing {
		state Testing {

            on entry do
                //erase previous dump files, if they exist to avoid appending to the results of previous tests...
                'if(' & fs & '.existsSync(\'dump\')) {'
                '' & fs & '.unlinkSync(\'dump\');}'
            end

            internal event m : dump?testOut
            action do
                write(""+m.c)
            end

            transition -> Failed
            event dump?testFailure

            transition -> End
            event dumpEnd?testEnd
		}

		final state Failed {
			on entry do
			    write("*FAILURE*")
			    'process.exit(1);'
			end
		}

		final state End {
			on entry do
        print " [Done]\n"
        'process.exit(0);'
			end
		}
	}
}
